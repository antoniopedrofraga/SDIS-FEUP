package channels;

import java.io.IOException;
import java.net.InetAddress;
import java.net.MulticastSocket;
import java.util.concurrent.ThreadLocalRandom;

import messages.Header;
import messages.Message;
import peers.MdbThread;
import peers.Peer;
import utilities.Constants;

public class MdbChannel {
	
	private MdbThread mdbThread;
	private MulticastSocket mdbSocket;
	private InetAddress mdbAddress;
	private int mdbPort;
	
	MdbChannel(String mdbAddress, String mdbPort) {
		this.mdbAddress = InetAddress.getByName(mdbAddress);
		this.mdbPort = Integer.parseInt(mdbPort);
		this.mdbSocket = new MulticastSocket(this.mdbPort);
		this.mdbThread = new MdbThread();
	}
	
	public void listen() {
		
	}
	
	private class MdbThread extends Thread {
		public void run() {
			while(true) {
				System.out.println("Listening the MDB channel...");
				try {
					String data = Peer.rcvMultiCastData(mdbSocket, mdbAddress);
					String[] splittedMsg = Message.splitArgs(data);
					if(!serverId.equals(splittedMsg[Constants.SENDER_ID])) {
						Header header = new Header(Constants.STORED, splittedMsg[Constants.VERSION],
								serverId, splittedMsg[Constants.FILE_ID], splittedMsg[Constants.CHUNK_NO], null);
						Message reply = new Message(mcSocket, mcAddress, header, null);
						int timeout = ThreadLocalRandom.current().nextInt(0, 400);
						System.out.println("Waiting time: " + timeout);
						Thread.sleep(timeout);
						new Thread(reply).start();
					}
				} catch (IOException | InterruptedException e) {
					e.printStackTrace();
				}
			}
		}
	}
}
